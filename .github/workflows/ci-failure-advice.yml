name: CI Failure Advice

on:
  workflow_run:
    workflows: ["Main"]
    types:
      - completed

permissions:
  contents: read
  pull-requests: write

jobs:
  advise:
    name: Comment guidance on CI failures
    if: ${{ github.event.workflow_run.conclusion == 'failure' && github.event.workflow_run.event == 'pull_request' }}
    runs-on: ubuntu-latest
    steps:
      - name: Post guidance comment
        uses: actions/github-script@v7
        with:
          script: |
            const pr = context.payload.workflow_run.pull_requests && context.payload.workflow_run.pull_requests[0];
            if (!pr) {
              core.info('No associated PR found.');
              return;
            }
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const prNumber = pr.number;
            const advice = [
              'CI failed. Here are common fixes:',
              '',
              '- Lint: run `yarn lint` locally and fix reported issues.',
              '- Snapshots: run `yarn test:update` to refresh snapshots, then push.',
              '- Or trigger the manual workflow “Update Jest snapshots” with your branch name.',
              '- Visuals: if Chromatic is configured, review visual changes on the Chromatic check. Otherwise, use the Storybook PR preview (S3) if available.',
            ].join('\\n');
            await github.rest.issues.createComment({
              owner,
              repo,
              issue_number: prNumber,
              body: advice
            });
